---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Auto-categorize posts based on title keywords
function getPostTopic(title: string, explicitTopic?: string): string {
  if (explicitTopic) return explicitTopic;

  const titleLower = title.toLowerCase();

  // EMOD/Training modules
  if (titleLower.includes('module') || titleLower.includes('emod') || titleLower.includes('learning path')) {
    return 'EMOD Training';
  }

  // Resilience Councils
  if (titleLower.includes('resilience council') || titleLower.includes('resilience councils')) {
    return 'Resilience Councils';
  }

  // Policy & Governance
  if (titleLower.includes('policy') || titleLower.includes('dsa') || titleLower.includes('regulation') ||
      titleLower.includes('governance') || titleLower.includes('proposal')) {
    return 'Policy';
  }

  // FIMI & Disinformation
  if (titleLower.includes('fimi') || titleLower.includes('disinformation') || titleLower.includes('misinformation') ||
      titleLower.includes('manipulation') || titleLower.includes('narrative')) {
    return 'FIMI Analysis';
  }

  // AI & Technology
  if (titleLower.includes('ai') || titleLower.includes('artificial intelligence') || titleLower.includes('technology') ||
      titleLower.includes('algorithm') || titleLower.includes('platform')) {
    return 'AI & Technology';
  }

  // Research & Theory
  if (titleLower.includes('research') || titleLower.includes('study') || titleLower.includes('analysis') ||
      titleLower.includes('belief') || titleLower.includes('psychology')) {
    return 'Research';
  }

  return 'General';
}

// Get all blog posts, sorted by date (newest first)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

// Add topics to posts
const postsWithTopics = posts.map(post => ({
  ...post,
  topic: getPostTopic(post.data.title, post.data.topic)
}));

// Get unique topics and their counts
const topicCounts = postsWithTopics.reduce((acc, post) => {
  acc[post.topic] = (acc[post.topic] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const topics = Object.entries(topicCounts)
  .sort((a, b) => b[1] - a[1]) // Sort by count descending
  .map(([topic, count]) => ({ topic, count }));

const totalPosts = posts.length;
const defaultTopic = topicCounts['General'] ? 'General' : 'all';
const defaultCount = defaultTopic === 'all' ? totalPosts : topicCounts[defaultTopic];
const defaultResultsText = defaultTopic === 'all'
  ? `Showing all ${defaultCount} articles`
  : `Showing ${defaultCount} articles in "${defaultTopic}"`;
---

<BaseLayout title="Insights" description="Analysis, opinions, and updates on combating foreign information manipulation from the SAUFEX team.">

  <!-- Page Header -->
  <section class="page-header">
    <div class="container">
      <span class="page-header__label">Research & Analysis</span>
      <h1 class="page-header__title">Insights</h1>
      <p class="page-header__subtitle">
        {totalPosts} articles on combating foreign information manipulation and building democratic resilience.
      </p>
    </div>
  </section>

  <!-- Topic Filters -->
  <section class="filters-section">
    <div class="container">
      <div class="filters">
        <button class:list={['filter-btn', { 'filter-btn--active': defaultTopic === 'all' }]} data-topic="all">
          All <span class="filter-count">{totalPosts}</span>
        </button>
        {topics.map(({ topic, count }) => (
          <button class:list={['filter-btn', { 'filter-btn--active': topic === defaultTopic }]} data-topic={topic}>
            {topic} <span class="filter-count">{count}</span>
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Posts Grid -->
  <section class="content-section">
    <div class="container">
      <p class="results-count" id="results-count">{defaultResultsText}</p>
      <div class="posts-grid posts-grid--full" id="posts-grid">
        {postsWithTopics.map((post, i) => (
          <a href={`/insights/${post.data.slug || post.id}`} class="post-card" data-topic={post.topic}>
            <div class="post-card__header">
              <span class="post-card__number">â„– {totalPosts - i}</span>
              <span class="post-card__topic">{post.topic}</span>
            </div>
            <h3 class="post-card__title">{post.data.title}</h3>
            {post.data.description && (
              <p class="post-card__excerpt">{post.data.description}</p>
            )}
            <div class="post-card__meta">
              {post.data.author && <span>{post.data.author}</span>}
              <span>{new Date(post.data.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <script is:inline>
    if (typeof document !== 'undefined') {
      // Topic filtering
      const filterBtns = document.querySelectorAll('.filter-btn');
      const postCards = document.querySelectorAll('.post-card');
      const resultsCount = document.getElementById('results-count');
      const defaultTopic = {JSON.stringify(defaultTopic)};

      const applyFilter = (topic) => {
        // Update active state
        filterBtns.forEach(b => b.classList.remove('filter-btn--active'));
        const activeBtn = Array.from(filterBtns).find(btn => btn.getAttribute('data-topic') === topic);
        activeBtn?.classList.add('filter-btn--active');

        // Filter posts
        let visibleCount = 0;
        postCards.forEach(card => {
          const cardTopic = card.getAttribute('data-topic');
          if (topic === 'all' || cardTopic === topic) {
            card.style.display = '';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Update results count
        if (topic === 'all') {
          resultsCount.textContent = `Showing all ${visibleCount} articles`;
        } else {
          resultsCount.textContent = `Showing ${visibleCount} articles in "${topic}"`;
        }
      };

      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const topic = btn.getAttribute('data-topic');
          if (topic) applyFilter(topic);
        });
      });

      applyFilter(defaultTopic);
    }
  </script>

</BaseLayout>

<style>
  .page-header {
    padding: calc(80px + var(--space-2xl)) 0 var(--space-xl);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }

  .page-header__label {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-purple);
    margin-bottom: var(--space-md);
  }

  .page-header__label::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--color-gold);
    border-radius: 50%;
  }

  .page-header__title {
    font-size: clamp(2.5rem, 5vw, 4rem);
    margin-bottom: var(--space-sm);
  }

  .page-header__subtitle {
    font-size: 1.1rem;
    color: var(--color-muted);
    max-width: 50ch;
  }

  /* Topic Filters */
  .filters-section {
    padding: var(--space-lg) 0;
    background: #f5f5f7;
    position: sticky;
    top: 60px;
    z-index: 50;
  }

  .filters {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
  }

  .filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: white;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 100px;
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--color-muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-btn:hover {
    border-color: var(--color-purple);
    color: var(--color-purple);
  }

  .filter-btn--active {
    background: var(--color-dark);
    border-color: var(--color-dark);
    color: white;
  }

  .filter-btn--active:hover {
    background: var(--color-purple);
    border-color: var(--color-purple);
    color: white;
  }

  .filter-count {
    font-size: 0.75rem;
    opacity: 0.7;
  }

  .results-count {
    font-size: 0.875rem;
    color: var(--color-muted);
    margin-bottom: var(--space-lg);
  }

  /* Post Card Updates */
  .post-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
  }

  .post-card__topic {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 4px 10px;
    background: rgba(107, 76, 230, 0.1);
    color: var(--color-purple);
    border-radius: 100px;
  }

  .posts-grid--full {
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  }

  .post-card__meta {
    display: flex;
    justify-content: space-between;
    gap: var(--space-sm);
  }

  @media (max-width: 768px) {
    .filters-section {
      top: 56px;
    }

    .filters {
      overflow-x: auto;
      flex-wrap: nowrap;
      padding-bottom: var(--space-xs);
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .filters::-webkit-scrollbar {
      display: none;
    }

    .filter-btn {
      flex-shrink: 0;
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .posts-grid--full {
      grid-template-columns: 1fr;
    }
  }
</style>
